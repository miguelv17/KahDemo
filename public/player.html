<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Qwizu · Player</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/styles.css" rel="stylesheet">
  <style>
    .answers-grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:1rem; }
    .answer { border:1px solid #dee2e6; border-radius:.75rem; cursor:pointer; }
    .answer.correct { border-color: rgba(25,135,84,.5); }
    .answer.dim { opacity:.6; }
    .answer-0 { background: var(--bs-primary-bg-subtle); }
    .answer-1 { background: var(--bs-success-bg-subtle); }
    .answer-2 { background: var(--bs-warning-bg-subtle); }
    .answer-3 { background: var(--bs-danger-bg-subtle); }
  </style>
</head>
<body>
<main class="container py-4" style="max-width:540px">
  <div class="card"><div class="card-body">
    <h5 class="mb-3">Unirse a partida</h5>
    <div class="row g-2">
      <div class="col-6"><input id="code" class="form-control" placeholder="PIN"></div>
      <div class="col-6"><input id="name" class="form-control" placeholder="Tu nombre"></div>
    </div>
    <button id="btnJoin" class="btn btn-primary mt-3 w-100">Unirse</button>
    <div id="nameAlert" class="alert alert-warning mt-2 d-none" role="alert">
      Ese nombre no está permitido. Por favor elige otro.
    </div>
  </div></div>

  <div id="game" class="d-none">
    <div class="mt-3 card"><div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <div><span id="badgeIndex" class="badge bg-warning text-dark">0/0</span></div>
        <div><span id="badgeTimer" class="badge bg-info">—</span></div>
      </div>
      <h4 id="qText" class="mt-2"></h4>
      <div id="opts" class="answers-grid"></div>
      <div id="feedback" class="mt-2 small text-muted"></div>
    </div></div>
  </div>

  <div id="gameOver" class="d-none">
    <div class="mt-3 card"><div class="card-body text-center">
      <h4 id="finalMsg" class="mb-3"></h4>
      <ol id="finalPodium" class="list-group list-group-numbered mb-3 text-start"></ol>
      <button id="btnFinish" class="btn btn-primary w-100">Finalizar</button>
    </div></div>
  </div>
</main>
<script src="/socket.io/socket.io.js"></script>
<script type="module">
  import { connectSocket, fmtTime } from './client.js';
  const s = connectSocket();
  const $ = sel => document.querySelector(sel);
  let joined=false, code=null, answered=false, tick=0, timerId=null, timeLimit=20, playerName='';
  const banned = ['puto','puta','cabron','pendejo','ching','verga','coño','culo','mierda','pito','pene','vagina','nalgas'];

  const params = new URLSearchParams(location.search);
  const codeParam = params.get('code');
  if(codeParam) $('#code').value = codeParam;

  $('#btnJoin').onclick = ()=>{
    $('#nameAlert').classList.add('d-none');
    code = $('#code').value.trim(); const name=$('#name').value.trim();
    if(banned.some(w=> name.toLowerCase().includes(w))){
      $('#nameAlert').classList.remove('d-none');
      return;
    }
    s.emit('player:join', { code, name }, (res)=>{
      if(!res.ok) return alert(res.error||'No se pudo unir');
      $('#btnJoin').disabled = true; $('#code').disabled = true; $('#name').disabled = true;
      $('#game').classList.remove('d-none'); joined=true; playerName=name;
    });
  };

  function startTimer(t){
    clearInterval(timerId); tick=t; $('#badgeTimer').textContent = fmtTime(tick);
    timerId = setInterval(()=>{ tick--; $('#badgeTimer').textContent = fmtTime(tick); if(tick<=0){ clearInterval(timerId); } }, 1000);
  }

  s.on('game:question', ({ index, total, text, options, timeLimit: tl })=>{
    timeLimit = tl; answered=false; $('#feedback').textContent='';
    $('#badgeIndex').textContent = `${index+1}/${total}`;
    $('#qText').textContent = text;
    const opts = $('#opts'); opts.innerHTML='';
    options.forEach((o,i)=>{
      const div = document.createElement('div');
      div.className = `card answer answer-${i}`;
      div.innerHTML = `<div class="card-body">${o}</div>`;
      div.onclick = ()=>{
        if(answered) return;
        answered=true;
        s.emit('player:answer', { code, choice:i }, (res)=>{ if(!res.ok) alert(res.error); });
        Array.from(document.querySelectorAll('#opts .answer')).forEach(b=>{b.style.pointerEvents='none';});
        $('#feedback').textContent='Respuesta enviada';
      };
      opts.appendChild(div);
    });
    startTimer(timeLimit);
  });

  s.on('game:reveal', ({ correct })=>{
    const cards = Array.from(document.querySelectorAll('#opts .answer'));
    cards.forEach((c,i)=>{ if(i===correct){ c.classList.add('correct'); } else { c.classList.add('dim'); }});
  });

  s.on('game:over', ({ scoreboard })=>{
    $('#game').classList.add('d-none');
    const rank = scoreboard.findIndex(p=>p.name===playerName) + 1;
    const total = scoreboard.length;
    $('#finalMsg').textContent = `Terminó el juego. Quedaste en el puesto ${rank} de ${total}.`;
    const pod = $('#finalPodium'); pod.innerHTML='';
    scoreboard.slice(0,3).forEach((p,i)=>{
      const li=document.createElement('li');
      li.className='list-group-item d-flex justify-content-between align-items-center';
      li.innerHTML=`<span>${p.name}</span><span class="badge bg-primary">${p.score}</span>`;
      if(p.name===playerName) li.classList.add('active');
      pod.appendChild(li);
    });
    $('#gameOver').classList.remove('d-none');
  });

  $('#btnFinish').onclick = ()=>{ location.reload(); };

  s.on('room:closed', ()=>{ alert('La sala se cerró'); location.reload(); });
</script>
</body>
</html>
