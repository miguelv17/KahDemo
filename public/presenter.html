<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PartyQuiz ¬∑ Presentador</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/styles.css" rel="stylesheet">
  <style>
    .answers-grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:1rem; }
    .answer { border:1px solid #dee2e6; border-radius:.75rem; }
    .answer.correct { border-color: rgba(25,135,84,.5); }
    .answer.dim { opacity:.6; }
    .answer-0 { background: var(--bs-primary-bg-subtle); }
    .answer-1 { background: var(--bs-success-bg-subtle); }
    .answer-2 { background: var(--bs-warning-bg-subtle); }
    .answer-3 { background: var(--bs-danger-bg-subtle); }
    .confetti { position:fixed; inset:0; pointer-events:none; }
  </style>
</head>
<body>
<nav class="navbar bg-light border-bottom">
  <div class="container"><span class="navbar-brand">Presentador ¬∑ PartyQuiz</span></div>
</nav>

<main class="container py-4">
  <div id="joinForm" class="mb-4">
    <div class="input-group" style="max-width:320px">
      <input id="joinCode" class="form-control" placeholder="PIN">
      <button id="btnJoin" class="btn btn-primary">Ver juego</button>
    </div>
  </div>
  <!-- Vista de juego en vivo -->
  <div id="view-live" class="d-none">
    <div id="roomCodeDisplay" class="display-1 text-center mb-4"></div>
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <span id="badgeIndex" class="badge bg-warning text-dark">0/0</span>
        <span id="badgeTimer" class="badge bg-info">‚Äî</span>
      </div>
      <div id="title" class="small text-muted">‚Äî</div>
    </div>

    <h2 id="qText" class="mb-3">Esperando pregunta‚Ä¶</h2>
    <div class="answers-grid" id="answers"></div>

    <div class="progress mt-4">
      <div id="timeBar" class="progress-bar bg-success" role="progressbar" style="width: 100%"></div>
    </div>
    <div id="preGame" class="card mt-4">
      <div class="card-body">
        <h5 class="mb-3">Jugadores</h5>
        <ul id="playerList" class="list-group list-group-flush mb-3"></ul>
        <button id="btnStart" class="btn btn-primary w-100">Iniciar juego</button>
      </div>
    </div>

    <div class="card mt-4">
      <div class="card-body">
        <h5>Marcador</h5>
        <div id="scoreboard" class="d-flex flex-column gap-2"></div>
      </div>
    </div>
  </div>

  <!-- Vista de podio -->
  <div id="view-podium" class="d-none">
    <h2 class="mb-4">üèÜ ¬°Podio!</h2>
    <ol id="podium" class="list-group list-group-numbered"></ol>
    <canvas class="confetti" id="confetti"></canvas>
  </div>
</main>

<script src="/socket.io/socket.io.js"></script>
<script>
  const s = io();
  const $ = sel => document.querySelector(sel);

  let code = null, timeLimit = 20, tick = 0, timerId = null;

  function startTimer(t){
    clearInterval(timerId);
    tick = t;
    updateTimerUI();
    timerId = setInterval(()=>{
      tick--; updateTimerUI();
      if(tick<=0){ clearInterval(timerId); }
    },1000);
  }
  function updateTimerUI(){
    $('#badgeTimer').textContent = tick + 's';
    const pct = Math.max(0, Math.min(100, Math.round((tick / timeLimit)*100)));
    $('#timeBar').style.width = pct+'%';
    $('#timeBar').className = 'progress-bar ' + (pct<25?'bg-danger':pct<60?'bg-warning text-dark':'bg-success');
  }

  function renderScoreboard(list){
    const c = $('#scoreboard'); c.innerHTML='';
    list.forEach((p,i)=>{
      const row = document.createElement('div');
      row.className = 'd-flex align-items-center gap-2 p-2 rounded';
      row.style.background = i===0? 'rgba(255,215,0,.15)':'rgba(0,0,0,.03)';
      row.innerHTML = `<div style="width:2rem;text-align:center">${i+1}</div>
                       <div class="flex-grow-1">${p.name}</div>
                       <div class="badge bg-secondary">${p.score}</div>`;
      c.appendChild(row);
    });
  }

  function fireConfetti(){
    const c = $('#confetti'); const ctx = c.getContext('2d');
    const W = c.width = innerWidth; const H = c.height = innerHeight;
    const N = 150;
    const parts = Array.from({length:N},()=>({x:Math.random()*W,y:-20-Math.random()*H,r:3+Math.random()*4,s:1+Math.random()*3,
      col:['#0d6efd','#20c997','#ffc107','#dc3545','#6f42c1'][Math.floor(Math.random()*5)]}));
    let t=0; const id=setInterval(()=>{
      ctx.clearRect(0,0,W,H);
      parts.forEach(p=>{p.y+=p.s; p.x+=Math.sin((t+p.r)/20); if(p.y>H+10) p.y=-10;
        ctx.fillStyle=p.col; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();});
      t++; if(t>500) clearInterval(id);
    },16);
  }

  $('#btnJoin').onclick = ()=>{
    code = $('#joinCode').value.trim();
    s.emit('presenter:join', { code }, (res)=>{
      if(!res.ok) return alert(res.error||'PIN inv√°lido');
      $('#joinForm').classList.add('d-none');
      $('#view-live').classList.remove('d-none');
      $('#roomCodeDisplay').textContent = code;
    });
  };

  $('#btnStart').onclick = ()=>{
    s.emit('presenter:start', { code }, (res)=>{ if(!res.ok) alert(res.error||'No se pudo iniciar'); });
  };

  s.on('room:update', ({ players })=>{
    const ul = $('#playerList'); ul.innerHTML='';
    players.forEach(p=>{ const li=document.createElement('li'); li.className='list-group-item'; li.textContent=p.name; ul.appendChild(li); });
  });

  // Eventos de juego
  s.on('game:question', ({ index,total,text,options,timeLimit:tl,title })=>{
    $('#view-live').classList.remove('d-none');
    $('#view-podium').classList.add('d-none');
    $('#preGame').classList.add('d-none');
    $('#roomCodeDisplay').classList.add('d-none');
    timeLimit = tl; startTimer(timeLimit);
    $('#badgeIndex').textContent = (index+1)+'/'+total;
    $('#title').textContent = title;
    $('#qText').textContent = text;
    const ans=$('#answers'); ans.innerHTML='';
    options.forEach((o,i)=>{
      const div=document.createElement('div');
      div.className='card answer answer-'+i;
      div.innerHTML=`<div class="card-body d-flex align-items-center"><span class="badge bg-secondary me-2">${['A','B','C','D'][i]}</span><span>${o}</span></div>`;
      ans.appendChild(div);
    });
  });

  s.on('game:reveal', ({ correct,scoreboard })=>{
    const cards=document.querySelectorAll('.answer');
    cards.forEach((c,i)=>{ if(i===correct) c.classList.add('correct'); else c.classList.add('dim'); });
    renderScoreboard(scoreboard);
  });

  s.on('game:over', ({ podium })=>{
    $('#view-live').classList.add('d-none');
    $('#view-podium').classList.remove('d-none');
    const pod=$('#podium'); pod.innerHTML='';
    podium.forEach((p,i)=>{
      const li=document.createElement('li');
      li.className='list-group-item d-flex justify-content-between align-items-center';
      li.innerHTML=`<span>${p.name}</span><span class="badge bg-primary">${p.score} pts</span>`;
      pod.appendChild(li);
    });
    fireConfetti();
  });
</script>
</body>
</html>
