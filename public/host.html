<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Qwizu · Host</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/styles.css" rel="stylesheet">
</head>
<body>
<nav class="navbar bg-light border-bottom"><div class="container"><span class="navbar-brand">Host · Qwizu</span></div></nav>
<main class="container py-4">
  <div class="row g-4">
    <div class="col-lg-7">
      <div class="card"><div class="card-body">
        <h5 class="mb-3">Crear partida</h5>
        <div class="row g-2">
          <div class="col-md-6"><input id="title" class="form-control" placeholder="Título" value="Trivia con Amigos"></div>
          <div class="col-6 col-md-3"><input id="timeLimit" type="number" min="5" value="20" class="form-control" placeholder="Tiempo (s)"></div>
          <div class="col-6 col-md-3"><input id="basePoints" type="number" min="100" step="50" value="1000" class="form-control" placeholder="Puntos base"></div>
        </div>
        <div class="mt-3 d-flex gap-2 align-items-center">
          <button id="btnCreate" class="btn btn-primary">Crear sala</button>
          <div class="ms-auto"><span class="badge bg-secondary">PIN: <span id="pin">—</span></span></div>
        </div>
      </div></div>

      <div class="card mt-3"><div class="card-body">
        <div class="d-flex align-items-center mb-2"><h6 class="mb-0">Preguntas</h6>
          <button class="btn btn-sm btn-outline-secondary ms-auto" id="btnSample">Cargar ejemplo</button></div>
        <textarea id="questions" class="form-control" rows="10" placeholder='[
  {"text":"¿Capital de México?","options":["CDMX","Guadalajara","Monterrey","Puebla"],"answer":0}
]'></textarea>
      </div></div>

      <div class="card mt-3"><div class="card-body">
        <div class="d-flex gap-2">
          <button id="btnStart" class="btn btn-primary" disabled>Iniciar juego</button>
          <button id="btnEnd" class="btn btn-danger" disabled>Finalizar juego</button>
        </div>
        <div class="mt-3">
          <div><span id="qIndex" class="badge bg-warning text-dark">0/0</span>
               <span id="timer" class="badge bg-info">—</span></div>
          <h4 id="qText" class="mt-2"></h4>
          <ol id="qOpts"></ol>
        </div>
      </div></div>
    </div>
    <div class="col-lg-5">
      <div class="card"><div class="card-body">
        <h6 class="mb-2">Jugadores</h6>
        <ul id="players" class="list-group list-group-flush"></ul>
      </div></div>

      <div class="card mt-3"><div class="card-body">
        <h6>Marcador</h6>
        <ul id="scoreboard" class="list-group list-group-flush"></ul>
      </div></div>
    </div>
  </div>
</main>
<script src="/socket.io/socket.io.js"></script>
<script type="module">
  import { connectSocket, fmtTime } from './client.js';
  const s = connectSocket();

  const $ = sel => document.querySelector(sel);
  let code = null, timeLimit = 20, timerId = null, tick = 0;

  $('#btnSample').onclick = ()=>{
    const sample = [
      {text:"¿Capital de México?", options:["Ciudad de México","Guadalajara","Monterrey","Puebla"], answer:0},
      {text:"¿Año de lanzamiento de Bootstrap 5 estable?", options:["2019","2020","2021","2022"], answer:2},
      {text:"¿Qué propiedad CSS crea un contenedor flexible?", options:["display:flex","position:flex","layout:flex","flex:1"], answer:0}
    ];
    $('#questions').value = JSON.stringify(sample, null, 2);
  };

  $('#btnCreate').onclick = () => {
    let parsedQuestions = [];
    try { parsedQuestions = JSON.parse($('#questions').value || '[]'); } catch (e) { alert('JSON inválido de preguntas'); return; }
    const payload = {
      title: $('#title').value,
      timeLimit: Number($('#timeLimit').value||20),
      basePoints: Number($('#basePoints').value||1000),
      questions: parsedQuestions
    };
    s.emit('host:create_room', payload, (res)=>{
      if(!res.ok) return alert(res.error||'Error creando sala');
      code = res.code;
      $('#pin').textContent = code;
      $('#btnStart').disabled = false;
      $('#btnEnd').disabled = false;
    });
  };

  function startTimer(t){
    clearInterval(timerId); tick=t; $('#timer').textContent = fmtTime(tick);
    timerId = setInterval(()=>{ tick--; $('#timer').textContent = fmtTime(tick); if(tick<=0){ clearInterval(timerId); } }, 1000);
  }

  $('#btnStart').onclick = ()=>{ if(!code) return; s.emit('host:start_question', { code }, (res)=>{ if(!res.ok) alert(res.error); }); };
  $('#btnEnd').onclick = ()=>{ if(!code) return; s.emit('host:end_game', { code }, (res)=>{ if(!res.ok) alert(res.error); }); };

  s.on('room:update', ({ title, players })=>{
    const ul = $('#players'); ul.innerHTML='';
    players.forEach(p=>{ const li=document.createElement('li'); li.className='list-group-item'; li.textContent=`${p.name}`; ul.appendChild(li); });
  });

  s.on('game:question', ({ index, total, text, options, timeLimit: tl })=>{
    timeLimit = tl;
    $('#btnEnd').disabled = false;
    $('#qIndex').textContent = `${index+1}/${total}`;
    $('#qText').textContent = text;
    const ol = $('#qOpts'); ol.innerHTML=''; options.forEach((o,i)=>{ const li=document.createElement('li'); li.textContent=o; ol.appendChild(li); });
    startTimer(timeLimit);
  });

  s.on('game:answered_count', ({ answered, total })=>{ $('#timer').textContent = `${fmtTime(tick)} · ${answered}/${total} respondieron`; });

  s.on('game:reveal', ({ correct, scoreboard })=>{
    const sb = $('#scoreboard'); sb.innerHTML='';
    scoreboard.forEach((p,i)=>{ const li=document.createElement('li'); li.className='list-group-item d-flex justify-content-between align-items-center'; li.innerHTML=`<span>${i+1}. ${p.name}</span><span class="badge bg-primary">${p.score}</span>`; sb.appendChild(li); });
  });

  s.on('game:over', ({ podium })=>{
    alert('Juego terminado! Podio:\n' + podium.map((p,i)=> `${i+1}. ${p.name} (${p.score})`).join('\n'));
    $('#btnStart').disabled=false;
    $('#btnEnd').disabled=true;
    $('#qIndex').textContent='0/0'; $('#qText').textContent=''; $('#qOpts').innerHTML=''; $('#timer').textContent='—';
    $('#scoreboard').innerHTML='';
  });

  s.on('room:closed', ()=>{ alert('La sala se cerró (host desconectado)'); location.reload(); });
</script>
</body>
</html>
